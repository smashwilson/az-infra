#!/bin/bash

set -euo pipefail

printf ">> Trusting SSH keys.\n"
curl --silent https://github.com/smashwilson.keys | sudo update-ssh-keys -u core -a smashwilson
printf ">> SSH keys trusted.\n"

printf ">> Enabling Docker service.\n"
sudo systemctl enable docker.service
printf ">> Docker service enabled.\n"

printf ">> Setting server timezone.\n"
sudo timedatectl set-timezone UTC
printf ">> Server timezone set.\n"

printf ">> Downloading az-coordinator.\n"
curl --silent '{{ az_coordinator.download_url }}' --output /home/core/az-coordinator
printf ">> az-coordinator downloaded.\n"

printf ">> Writing az-coordinator options.\n"
cat <<EOF >/home/core/options.json
{{ az_coordinator.options_json }}
EOF
printf ">> az-coordinator options written.\n"

printf ">> Bootstrapping host.\n"
sudo AZ_OPTIONS=/home/core/options.json az-coordinator -v init
printf ">> Host bootstrapped.\n"
